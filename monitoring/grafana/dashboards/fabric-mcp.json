{
  "annotations": {
    "list": []
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "title": "Request Rate (req/s)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "drawStyle": "line", "fillOpacity": 10 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_http_requests_total[5m]))",
          "legendFormat": "Total",
          "refId": "A"
        },
        {
          "expr": "sum(rate(mcp_http_requests_total{status=~\"5..\"}[5m]))",
          "legendFormat": "5xx Errors",
          "refId": "B"
        },
        {
          "expr": "sum(rate(mcp_http_requests_total{status=\"429\"}[5m]))",
          "legendFormat": "429 Rate Limited",
          "refId": "C"
        }
      ]
    },
    {
      "title": "Request Latency (p50 / p95 / p99)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": { "drawStyle": "line", "fillOpacity": 10 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(mcp_http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(mcp_http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "p95",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(mcp_http_request_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "p99",
          "refId": "C"
        }
      ]
    },
    {
      "title": "Active Requests",
      "type": "gauge",
      "gridPos": { "h": 8, "w": 6, "x": 0, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "red", "value": 50 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(mcp_http_requests_in_progress)",
          "legendFormat": "In Progress",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Error Rate (%)",
      "type": "stat",
      "gridPos": { "h": 8, "w": 6, "x": 6, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.01 },
              { "color": "red", "value": 0.05 }
            ]
          }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_http_requests_total{status=~\"5..\"}[5m])) / sum(rate(mcp_http_requests_total[5m]))",
          "legendFormat": "Error Rate",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Rate Limit Hits",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "bars", "fillOpacity": 50 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_rate_limit_hits_total[5m])) by (key_type)",
          "legendFormat": "{{key_type}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Tool Call Rate by Tool",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": { "drawStyle": "line", "fillOpacity": 10 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_tool_calls_total[5m])) by (tool)",
          "legendFormat": "{{tool}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Tool Latency by Tool (p95)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": { "drawStyle": "line", "fillOpacity": 10 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(mcp_tool_call_duration_seconds_bucket[5m])) by (le, tool))",
          "legendFormat": "{{tool}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Tool Errors by Tool",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "bars", "fillOpacity": 50 }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_tool_calls_total{status=\"error\"}[5m])) by (tool)",
          "legendFormat": "{{tool}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Tool Calls by User",
      "description": "Which user called which tool and how many times",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Calls" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(20, sum(mcp_tool_calls_total) by (user_sub, tool))",
          "legendFormat": "{{user_sub}} → {{tool}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "user_sub": "User", "tool": "Tool", "Value": "Calls" }
          }
        }
      ]
    },
    {
      "title": "Requests by User + Endpoint",
      "description": "Per-user per-path HTTP request breakdown",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Requests" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(20, sum(mcp_requests_by_user_path_total) by (user_sub, method, path))",
          "legendFormat": "{{user_sub}} {{method}} {{path}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "user_sub": "User", "method": "Method", "path": "Path", "Value": "Requests" }
          }
        }
      ]
    },
    {
      "title": "Top Users by Request Count",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Requests" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(10, sum(mcp_requests_by_user_total) by (user_sub))",
          "legendFormat": "{{user_sub}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "user_sub": "User", "Value": "Requests" }
          }
        }
      ]
    },
    {
      "title": "Auth Failures by Reason",
      "description": "Authentication failures broken down by reason (missing_token, malformed_header, invalid_jwt, expired_token)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 40 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": { "drawStyle": "bars", "fillOpacity": 50, "stacking": { "mode": "normal" } }
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum(rate(mcp_auth_failures_total[5m])) by (reason)",
          "legendFormat": "{{reason}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Auth Failures by IP",
      "description": "Top client IPs generating auth failures — spot brute-force or overseas probing",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 40 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Failures" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(20, sum(mcp_auth_failures_total) by (client_ip, reason))",
          "legendFormat": "{{client_ip}} ({{reason}})",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "client_ip": "Client IP", "reason": "Reason", "Value": "Failures" }
          }
        }
      ]
    },
    {
      "title": "Top Client IPs by Request Volume",
      "description": "All requests by IP — spot unusual traffic sources",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 48 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Requests" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(20, sum(mcp_requests_by_ip_total) by (client_ip))",
          "legendFormat": "{{client_ip}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "client_ip": "Client IP", "Value": "Requests" }
          }
        }
      ]
    },
    {
      "title": "User-to-IP Mapping (Auth Success)",
      "description": "Which users authenticated from which IPs — spot token reuse from unexpected locations",
      "type": "table",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 48 },
      "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [{ "id": "displayName", "value": "Requests" }]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(20, sum(mcp_auth_success_total) by (user_sub, client_ip))",
          "legendFormat": "{{user_sub}} @ {{client_ip}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "user_sub": "User", "client_ip": "Client IP", "Value": "Requests" }
          }
        }
      ]
    }
  ],
  "schemaVersion": 39,
  "tags": ["fabric", "mcp", "security"],
  "templating": { "list": [] },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "utc",
  "title": "FABRIC MCP",
  "uid": "fabric-mcp-dashboard",
  "version": 1
}
