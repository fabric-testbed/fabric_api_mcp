# =========================
# Frontend (443) - Vouch + Reports API + MCP endpoints
# =========================
server {
    listen 443 ssl http2;
    server_name $host;

    # --- allow larger request headers/cookies ---
    client_header_buffer_size 16k;
    large_client_header_buffers 8 64k;
    # -------------------------------------------

    root /var/www/html/;

    # TLS
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_certificate     /etc/ssl/public.pem;
    ssl_certificate_key /etc/ssl/private.pem;
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Size/time limits
    client_max_body_size 64m;
    proxy_read_timeout   1800s;
    proxy_send_timeout   1800s;
    proxy_connect_timeout 180s;
    send_timeout         1800s;

    # Forwarded headers for all proxied requests
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  $server_port;

    # POST /mcp (tool calls)
    location = /mcp {
        proxy_pass http://fabric-api-mcp:5000;
        proxy_pass_request_body on;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Length     $content_length;
        proxy_set_header Content-Type      $http_content_type;

        add_header Access-Control-Allow-Origin "https://alpha-5.fabric-testbed.net" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Authorization" always;
    }

    # =============================================
    # Vouch Proxy — CILogon OIDC auth for Grafana
    # =============================================

    # Internal validation endpoint
    location = /validate {
        internal;
        proxy_pass http://fabric-api-vouch:9090/validate;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Capture the ID token from vouch for Lua role check
        auth_request_set $auth_resp_x_vouch_idp_idtoken $upstream_http_x_vouch_idp_idtoken;
    }

    # Vouch callback / login / logout
    location /auth {
        proxy_pass http://fabric-api-vouch:9090/auth;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /login {
        proxy_pass http://fabric-api-vouch:9090/login;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /logout {
        proxy_pass http://fabric-api-vouch:9090/logout;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Redirect 401 to vouch login
    error_page 401 = @error401;
    location @error401 {
        return 302 https://$http_host/login?url=https://$http_host$request_uri;
    }

    # Grafana (served at /grafana/) — protected by Vouch + Lua role check
    location /grafana/ {
        auth_request /validate;
        auth_request_set $auth_resp_x_vouch_idp_idtoken $upstream_http_x_vouch_idp_idtoken;

        # Lua: decode JWT payload, check isMemberOf for required roles
        access_by_lua_block {
            local id_token = ngx.var.auth_resp_x_vouch_idp_idtoken
            if not id_token or id_token == "" then
                ngx.log(ngx.ERR, "No ID token from vouch")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            -- Split JWT: header.payload.signature
            local payload_b64 = id_token:match("^[^.]+%.([^.]+)")
            if not payload_b64 then
                ngx.log(ngx.ERR, "Malformed JWT: cannot extract payload")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            -- Base64url decode (replace - with +, _ with /, pad with =)
            local rem = #payload_b64 % 4
            if rem == 2 then payload_b64 = payload_b64 .. "=="
            elseif rem == 3 then payload_b64 = payload_b64 .. "="
            end
            payload_b64 = payload_b64:gsub("-", "+"):gsub("_", "/")
            local payload_json = ngx.decode_base64(payload_b64)
            if not payload_json then
                ngx.log(ngx.ERR, "Failed to base64-decode JWT payload")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local cjson = require("cjson.safe")
            local claims, err = cjson.decode(payload_json)
            if not claims then
                ngx.log(ngx.ERR, "Failed to parse JWT JSON: ", err)
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local is_member_of = claims["isMemberOf"]
            if not is_member_of or type(is_member_of) ~= "table" then
                ngx.log(ngx.WARN, "No isMemberOf claim in ID token")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local allowed = false
            for _, group in ipairs(is_member_of) do
                local name = ""
                if type(group) == "table" then
                    name = group["name"] or ""
                elseif type(group) == "string" then
                    name = group
                end
                if name:find("facility%-operators") or name:find("facility%-viewers") then
                    allowed = true
                    break
                end
            end

            if not allowed then
                ngx.log(ngx.WARN, "User lacks facility-operators or facility-viewers role")
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end
        }

        proxy_pass http://fabric-api-grafana:3000/grafana/;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Grafana WebSocket (live updates) — protected by Vouch + Lua role check
    location /grafana/api/live/ {
        auth_request /validate;
        auth_request_set $auth_resp_x_vouch_idp_idtoken $upstream_http_x_vouch_idp_idtoken;

        # Lua: decode JWT payload, check isMemberOf for required roles
        access_by_lua_block {
            local id_token = ngx.var.auth_resp_x_vouch_idp_idtoken
            if not id_token or id_token == "" then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local payload_b64 = id_token:match("^[^.]+%.([^.]+)")
            if not payload_b64 then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local rem = #payload_b64 % 4
            if rem == 2 then payload_b64 = payload_b64 .. "=="
            elseif rem == 3 then payload_b64 = payload_b64 .. "="
            end
            payload_b64 = payload_b64:gsub("-", "+"):gsub("_", "/")
            local payload_json = ngx.decode_base64(payload_b64)
            if not payload_json then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local cjson = require("cjson.safe")
            local claims = cjson.decode(payload_json)
            if not claims then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local is_member_of = claims["isMemberOf"]
            if not is_member_of or type(is_member_of) ~= "table" then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end

            local allowed = false
            for _, group in ipairs(is_member_of) do
                local name = ""
                if type(group) == "table" then
                    name = group["name"] or ""
                elseif type(group) == "string" then
                    name = group
                end
                if name:find("facility%-operators") or name:find("facility%-viewers") then
                    allowed = true
                    break
                end
            end

            if not allowed then
                return ngx.exit(ngx.HTTP_FORBIDDEN)
            end
        }

        proxy_pass http://fabric-api-grafana:3000/grafana/api/live/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host       $host;
    }
}
